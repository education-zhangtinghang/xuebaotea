<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<title>首页</title>
		<script src="js/mui.min.js"></script>
		<script type="text/javascript" src="js/zoom/flexible.js"></script>
		<link href="css/mui.min.css" rel="stylesheet" />
		<style>
			html,
			body {
				background-color: #efeff4;
			}			
			ul,
			li {
				list-style: none;
				margin: 0;
				padding: 0;
			}

			/*轮播图*/
			
			.mui-slider{
				width: 100%;
				height: 5.555555rem;
				/*background-image: url(images/main/baner_picture.png);
				background-position: left top;
				background-repeat:no-repeat;
				background-size: 100% 100%;*/
			}
			
			.mui-slider-indicator {
				bottom: 24px;
			}
			/*课程表*/
			
			.course_box {
				display: flex;
				position: relative;
				width: 98%;
				margin: 0 auto;
				margin-top: -13px;
				padding: 0;
				height: 3.333333rem;
				justify-content: space-around;
				z-index: 9;
			}
			
			.course {
				width: 49.5%;
				height: 3.333333rem;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 0.5rem;
				color: #FFFFFF;
			}
			.course_indent{
				background-color: #4ea9ef;
			}
			.course_indent img{
				width: 1.166666rem;
				height: 1.25rem;
				margin-right: 0.541666rem;
			}
			.course_arrange{
				background-color: #33c1a1;
			}
			.course_arrange img{
				width: 1.194444rem;
				height: 1.236111rem;
				margin-right: 0.541666rem;
			}
			/*服务消息*/
			
			.serve_nav{
				width: 100%;
				height: 1.063888rem;
				border-bottom: 1px solid rgba(240, 240, 240, 1);
				display: flex;
				align-items: center;
				background-color: rgba(255, 255, 255, 1);
				margin-top: 0.222222rem;
			}
			
			.nav_line {
				width: 3px;
				background-color: #0DAD95;
				height: 0.436666rem;
				margin-left: 5%;
			}
			
			.nav_serve {
				width: 70%;
				margin-top: 0.128888rem;
				margin-left: 0.163333rem;
				color: rgba(136, 136, 136, 1);
				font-size: 0.388888rem;
			}
			
			.nav_more {
				width: 30%;
				text-align: right;
				padding-right: 5%;
				color: rgba(136, 136, 136, 1);
			}
			
			.class_message {
				width: 100%;
				background-color: rgba(255, 255, 255, 1);
				margin-bottom: 0.111111rem;
			}
			.class_message:active{
				background-color: rgb(240,240,240);
			}
			
			.message_title {
				display: flex;
				padding: 0.222222rem 5%;
				align-items: center;
			}
			
			.title_img {
				width: 0.75rem;
				height: 0.75rem;
			}
			
			.title_img img {
				width: 100%;
				height: 100%;
			}
			
			.title_text {
				padding-left: 0.388888rem;
				font-size: 0.416666rem;
				color: rgb(51, 51, 51);
			}
			
			.title_time {
				color: rgba(136, 136, 136, 1);
				padding-left: 0.222222rem;
				font-size: 0.277777rem;
			}
			
			.message_body {
				width: 100%;
				padding-bottom: 0.388888rem;
				display: flex;
				justify-content: space-between;
				color: rgba(136, 136, 136, 1);
			}
			
			.body_choose {
				color: rgba(85, 85, 85, 1);
				font-size:0.388888rem;
				margin-left: 5%;
				padding-left: 1.138rem;
			}
			
			.body_detail {
				color: rgb(136, 136, 136);
				font-size: 0.277777rem;
				padding-right: 5%;
				display: inline-flex;
				align-items: center;
			}
			
			.body_detail>img {
				width: 0.166666rem;
				height: 0.152777rem;
				margin-left: 0.057777rem;
			}
			#msg-content{
				padding-bottom: 51px;
			}			
			
		</style>
	</head>

	<body>
		<div class="mui-content" id="msg-content">
				<!--静态图片-->
				<!--<img v-if="sliderBox.num == 1" id="img1" :src="sliderBox.ajaxUrl+item.carouselImageUrl" />-->
				<!--轮播图片-->
				<div id="slider" class="mui-slider" >
					<!--<img src="images/cbd.jpg" />-->
				</div>
			

			<!--课程表-->
			<div class="course_box">
				<div class="course course_indent" id="course"><img src="images/main/order_arrange.png" />课程订单</div>
				<div class="course course_arrange" id="arrangement">
					<img src="images/main/class_arrange.png" />
					课程安排
				</div>
			</div>
			<!--服务消息-->
			<div class="serve_nav" id="course_box">
				<div class="nav_line"></div>
				<span class="nav_serve">服务消息</span>
				<div id="server_more" class="nav_more" v-if="serverArr.length != 0">更多</div>
			</div>
			<div class="mui-scroll-wrapper" id="mui-scroll-wrapper">
				<div class="mui-scroll" id="mui-scroll">
					
					<div v-for="(item, key, index) in serverArr" class="class_message" v-if="item.type!=13 || item.type!=14" :data-type="item.type | serverType" :data-detailId="item.detailId" :data-typeNew="item.type" :data-id="item.id">
						<div class="message_title">
							<div class="title_img"><img :src="item.type | itemImg" /></div>
							<div class="title_text" v-text="item.desc"></div>
							<div class="title_time" v-cloak>{{item.time | dateTime}}</div>
						</div>
						<div class="message_body">
							<div class="body_choose" v-text="item.message"></div>
							<div class="body_detail">查看详情  <img src="images/main/look_detail_icon.png"/></div>
						</div>
					</div>
					
				</div>
			</div>
			
			<!--取出加密值-->
			<input type="text" style="visibility:hidden" id="getPassword" value="" />
		</div>
		<!--原生渲染插件-->
		<script src="js/util.js"></script>
		<!--引入环信SDK-->
		<script type="text/javascript" src="js/IM/webim.config.js"></script>
		<script type="text/javascript" src="js/IM/strophe-1.2.8.min.js"></script>
		<script type="text/javascript" src="js/IM/websdk-1.4.13.js"></script>
		<!--end-->
		<script type="text/javascript" src="js/config.js"></script>
		<script type="text/javascript" src="js/login_config.js"></script>
		<script type="text/javascript" src="js/vue.min.js" ></script>
		<script type="text/javascript" src="js/storage/websql.js" ></script>
		<script type="text/javascript" src="js/hmac-sha1.js" ></script>
		<script type="text/javascript" src="js/ajax.js" ></script>
		<script type="text/javascript" src="js/index.js" ></script>
		<script type="text/javascript">
			var aniShow = {}; 
			mui.init({
				swipeBack: false //关闭右滑关闭功能
			});
			mui.plusReady(function () {
			    // 创建子webview窗口 并初始化
				util.initSubpage(aniShow);				
				var nview = plus.nativeObj.View.getViewById('tabBar'),
					activePage = plus.webview.currentWebview(),
					targetPage,
					subpages = util.options.subpages,
					pageW = window.innerWidth,
					currIndex = 0;

				/**
				 * 根据判断view控件点击位置判断切换的tab
				 */
				nview.addEventListener('click', function(e) {
					var clientX = e.clientX;
					if(clientX > parseInt(pageW * 0) && clientX <= parseInt(pageW * 0.25)) {
						currIndex = 0;
					} else if(clientX > parseInt(pageW * 0.26) && clientX <= parseInt(pageW * 0.5)) {
						currIndex = 1;
					}else if(clientX > parseInt(pageW * 0.51) && clientX <= parseInt(pageW * 0.75)) {
						currIndex = 2;
					}else if(clientX > parseInt(pageW * 0.76) && clientX <= parseInt(pageW * 1)) {
						currIndex = 3;
					}
					// 匹配对应tab窗口	
					if(currIndex > 0) {
						targetPage = plus.webview.getWebviewById(subpages[currIndex - 1]);
					} else {
						targetPage = plus.webview.currentWebview();
					}

					if(targetPage == activePage) {
						return;
					}

					//底部选项卡切换
					util.toggleNview(currIndex);
					// 子页面切换
					util.changeSubpage(targetPage, activePage, aniShow);
					//更新当前活跃的页面
					activePage = targetPage;
				});
				
				
				//轮播图相关数据处理（字符串拼接）
				var slider = mui("#slider");				
					slider.slider({
						interval: 200
					});
				var ajaxData = {
						url:'public/app/carousel',
						data: {
							type:'teacher'
						},
						type:'post'
					}
				ajax(ajaxData, function(data){
					if(data.data){
						creatSlider(data.data);
					}else{
						console.log('请求轮播失败',JSON.stringify(data))
					}						
				});
				
				//登录状态检测 
				var state = app.getState();
				if(state.data){
					if(!state || !state.data){
						openView.incView('login/login.html', 'login', '欢迎登陆');
					}
				}else{
					openView.incView('login/login.html', 'login', '欢迎登陆');
				}
				
				//监听个推消息
				push();
				//更新个推
				updateClient();
				//获取个推消息
				getServerMess();
				//监听登录刷新
				window.addEventListener('showView',function(event){
					push();
					updateClient();
					getServerMess();
				});
				//课程订单
				document.getElementById("course").addEventListener('tap',function(){
					openView.nativeView('pages_main/single_class.html', 'single_class', '课程订单','','none');
				})
				//课程安排
				document.getElementById("arrangement").addEventListener('tap',function(){
					openView.nativeView('pages_main/calendar.html', 'calendar', '课程安排','','none');
				})
				//更多服务
				document.getElementById("server_more").addEventListener('tap',function(){
					openView.nativeView('pages_main/server_list.html', 'server_list', '服务消息','','none');
				});
				//具体服务
				mui('#mui-scroll').on('tap','.class_message',function(){
					var type = this.getAttribute('data-type');
					var sid = this.getAttribute('data-id');
					var detailId = this.getAttribute('data-detailId');
					switch(type)
						{
						case '1':
							openView.nativeView('pages_main/in_class.html', 'in_class', '上课中',{sid:sid});
							break;
						case '2':
							openView.nativeView('pages_main/pay_success.html', 'pay_success', '充值成功',{sid:sid});
							break;
						case '3':
							chooseCourse(sid,detailId);							
							break;
						case '4':
							openView.nativeView('pages_main/Withdrawal_success.html', 'Withdrawal_success', '提现成功',{sid:sid});
							break;
						case '5':
							openView.nativeView('pages_main/course_remind.html', 'course_remind', '上课提醒',{sid:sid});
							break;
						case '6':
							plus.nativeUI.toast('此功能尚未开通~');
//							openView.nativeView('course_arrangement.html', 'course_arrangement', '课程安排',{sid:sid});
							break;
						case '7':
							openView.nativeView('pages_main/indent_succ.html', 'indent_succ', '订单信息',{sid:sid});
						break;
						case '8':
							openView.nativeView('pages_myself/indent_detail.html', 'indent_detail', '订单详情',{sid:sid});
						break;
						case '9':
							plus.nativeUI.toast('此功能尚未开通~');
						break;
						default:		
						}
				})
				
				function chooseCourse(sid,detailId){
					//推送的课堂反馈，需先查到课程id
				    if(sid){
				    	var ajaxData = {
							url:'restful1/message/getServiceMessageById',
							data: {
								id:sid,
							},
							type:'post'
						}
						ajax(ajaxData, function(data) {
							console.log(JSON.stringify(data))
								if(data.code == 200){
									//判断是否填写课堂反馈，如果反馈，查看信息，若未反馈，填写反馈
									if(data.data.feedback){
										var courseDetail = data.data;
										openView.nativeView('pages_main/classroom_detail.html', 'classroom_detail', '课堂反馈',{courseDetail:courseDetail,courseSection:detailId});
									}else{
										openView.nativeView('pages_main/fill_feedback.html', 'fill_feedback', '课堂反馈',{sid:sid,courseId:detailId});
									}							
								}else{
									if(data.code){
										plus.nativeUI.toast(data.msg);
									}else{
										plus.nativeUI.toast(data.err);
									}
								}
						},true);
				    }
					
				}
			})
				Vue.filter('serverType',function(value){
					return serverType(value);
				})
				//服务消息图片
				Vue.filter('itemImg',function(value){
					return serverImg(value);
				})
				Vue.filter('dateTime',function(value){
					var value = value.replace(/-/g,"/");
					return dateUtils.format(value)
				})
				var vm = new Vue({
					el: '#msg-content',
					data: {
						serverArr:{}
					}			
				})
			
				//框架调整
				var course_box = document.getElementById("course_box");
				var courseOffSetHeight = course_box.offsetHeight;
				var courseOffSetTop = course_box.offsetTop;
				var mui_scroll_wrapper = document.getElementById("mui-scroll-wrapper");
				var ViewHeight = window.innerHeight;
				var mui_scroll = document.getElementById("mui-scroll");
				mui_scroll_wrapper.style.height  = ViewHeight - courseOffSetHeight - courseOffSetTop -50 + 'px';
				mui_scroll_wrapper.style.top = courseOffSetHeight + courseOffSetTop + 'px';
				//DIV局部滚动
				mui('.mui-scroll-wrapper').scroll({
					deceleration:0.00006,
					indicators: true //是否显示滚动条
				});
						
			function creatSlider(data){
					var len = data.length;
					// 图片
					var sliderGroup = document.createElement("div");
					sliderGroup.className = "mui-slider-group mui-slider-loop";
					var group  = '<div class="mui-slider-item mui-slider-item-duplicate">'+
						'<a href="javascript:;" data-type="'+ajaxUrl+data[len-1].carouselUrl+'">'+
							'<img src="'+ajaxUrl+data[len-1].carouselImageUrl+'">'+
						'</a>'+
					'</div>';
					for(var i=0; i < len;i++){
						group += '<div class="mui-slider-item">'+
							'<a href="javascript:;" data-type="'+ajaxUrl+data[i].carouselUrl+'">'+
								'<img src="'+ajaxUrl+data[i].carouselImageUrl+'">'+
							'</a>'+
						'</div>';
					}
					group += '<div class="mui-slider-item mui-slider-item-duplicate">'+
						'<a href="javascript:;" data-type = "'+ajaxUrl+ data[0].carouselUrl +'">'+
							'<img src="'+ajaxUrl+data[0].carouselImageUrl+'">'+
						'</a>'+
					'</div>';
					sliderGroup.innerHTML = group;
					
					// 圆点
					var sliderIndicator = document.createElement("div");
					sliderIndicator.className = "mui-slider-indicator";
					for(var i=0; i < len;i++){
						var item = document.createElement("div");
						item.className = "mui-indicator";
						if(i==0){
							item.classList.add('mui-active');
						}
						sliderIndicator.appendChild(item);
					}
						
					var slider = document.getElementById('slider');
					slider.appendChild(sliderGroup);
					slider.appendChild(sliderIndicator);
					
					mui("#slider").slider({
						interval: 5000
					});
				}
		</script>
	</body>

</html>